name: Deploy to Kubernetes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG }}
    
    - name: Update image tags in manifests
      run: |
        sed -i "s|todo-backend:latest|${{ secrets.DOCKER_HUB_USERNAME }}/todo-backend:main-${{ github.sha }}|g" k8s/backend-deployment.yaml
        sed -i "s|todo-frontend:latest|${{ secrets.DOCKER_HUB_USERNAME }}/todo-frontend:main-${{ github.sha }}|g" k8s/frontend-deployment.yaml
        sed -i "s|imagePullPolicy: Never|imagePullPolicy: Always|g" k8s/backend-deployment.yaml
        sed -i "s|imagePullPolicy: Never|imagePullPolicy: Always|g" k8s/frontend-deployment.yaml
    
    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f k8s/mongodb-pvc.yaml
        kubectl apply -f k8s/mongodb-deployment.yaml
        kubectl apply -f k8s/backend-deployment.yaml
        kubectl apply -f k8s/frontend-deployment.yaml
    
    - name: Wait for deployment to complete
      run: |
        kubectl rollout status deployment/backend -w --timeout=5m
        kubectl rollout status deployment/frontend -w --timeout=5m
    
    - name: Verify deployment
      run: |
        kubectl get pods
        kubectl get services
