name: Docker Compose Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  docker-compose-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build and start services
      run: docker-compose up -d --build
    
    - name: Wait for services to be ready
      run: |
        echo "Waiting for backend to be ready..."
        timeout 60 sh -c 'until curl -f http://localhost:4000 > /dev/null 2>&1; do sleep 2; done'
        echo "Backend is ready!"
        
        echo "Waiting for frontend to be ready..."
        timeout 60 sh -c 'until curl -f http://localhost:3000 > /dev/null 2>&1; do sleep 2; done'
        echo "Frontend is ready!"
    
    - name: Test API endpoints
      run: |
        # Test health endpoint
        curl -f http://localhost:4000 || exit 1
        
        # Test GET todos
        curl -f http://localhost:4000/api/todos || exit 1
        
        # Test POST todo
        curl -f -X POST http://localhost:4000/api/todos \
          -H "Content-Type: application/json" \
          -d '{"title":"Test Todo"}' || exit 1
    
    - name: Show logs on failure
      if: failure()
      run: docker-compose logs
    
    - name: Cleanup
      if: always()
      run: docker-compose down -v
